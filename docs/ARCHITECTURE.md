# CargoBay 技术架构

## 技术选型

| 层级 | 技术方案 | 理由 |
|------|----------|------|
| GUI | Tauri + React (TypeScript) | 跨平台、轻量、GitHub 热度最高的桌面框架 |
| CLI | Rust (clap) | 与后端同语言，单二进制分发 |
| 守护进程 | Rust (tokio) | 高性能异步运行时 |
| IPC | gRPC (tonic) | 高性能，类型安全，Rust 原生 |
| 虚拟化 (macOS) | Rust FFI → Virtualization.framework | macOS 原生性能 |
| 虚拟化 (Linux) | Rust → KVM (rust-vmm) | 内核级虚拟化 |
| 文件共享 | virtiofs | 近原生文件系统性能 |
| 容器运行时 | containerd + nerdctl | Docker 兼容，开源无限制 |
| K8s | k3s | 轻量级，资源占用低 |
| Linux 内核 | 定制精简 Linux 6.x | 最小化启动时间和内存占用 |

## 系统架构图

```
┌──────────────────────────────────────────────────────┐
│                    Host OS                            │
│                                                      │
│  ┌────────────┐  ┌──────────┐  ┌──────────────────┐  │
│  │  GUI App   │  │   CLI    │  │  Docker CLI      │  │
│  │  (Tauri +  │  │  (Rust/  │  │  (兼容层 socket  │  │
│  │   React)   │  │   clap)  │  │   代理)          │  │
│  └─────┬──────┘  └────┬─────┘  └───────┬──────────┘  │
│        │              │                │             │
│        └──────────┬───┴────────────────┘             │
│                   │ gRPC (tonic)                     │
│            ┌──────▼───────┐                          │
│            │   Daemon     │                          │
│            │   (Rust)     │                          │
│            └──────┬───────┘                          │
│                   │                                  │
│     ┌─────────────▼──────────────┐                   │
│     │  Hypervisor 抽象层 (trait) │                   │
│     ├──────────────┬─────────────┤                   │
│     │ macOS:       │ Linux:      │                   │
│     │ Vz.framework │ KVM         │                   │
│     │ (FFI)        │ (rust-vmm)  │                   │
│     └──────────────┴──────┬──────┘                   │
│                           │                          │
│     ┌─────────────────────▼──────────────────────┐   │
│     │           Lightweight Linux VM             │   │
│     │  ┌──────────────────────────────────────┐  │   │
│     │  │  Custom Linux Kernel 6.x             │  │   │
│     │  │  containerd + nerdctl                │  │   │
│     │  │  k3s (可选)                          │  │   │
│     │  │  virtiofs mount ← Host 文件系统      │  │   │
│     │  └──────────────────────────────────────┘  │   │
│     └────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────┘
```

## 关键设计决策

1. **全栈 Rust** — GUI 后端、Daemon、CLI、VM 引擎共享同一语言，减少技术栈复杂度
2. **Hypervisor trait 抽象** — 统一接口，各平台独立实现，新平台只需加一个 backend
3. **Tauri 做 GUI** — 比 Electron 省 60-90% 内存，比原生 GUI 省 3 倍开发成本
4. **gRPC 解耦** — GUI/CLI 与 Daemon 完全解耦，可独立开发和测试
